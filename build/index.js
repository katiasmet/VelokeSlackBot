'use strict';

var _isEmpty2 = require('lodash/isEmpty');

var _isEmpty3 = _interopRequireDefault(_isEmpty2);

var _remove2 = require('lodash/remove');

var _remove3 = _interopRequireDefault(_remove2);

var _toLower2 = require('lodash/toLower');

var _toLower3 = _interopRequireDefault(_toLower2);

var _uniq2 = require('lodash/uniq');

var _uniq3 = _interopRequireDefault(_uniq2);

var _botkit = require('botkit');

var _botkit2 = _interopRequireDefault(_botkit);

var _nodeFetch = require('node-fetch');

var _nodeFetch2 = _interopRequireDefault(_nodeFetch);

var _cron = require('cron');

var _replies = require('./settings/replies');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

//D4NP461K6

var controller = _botkit2.default.slackbot({
  debug: true
});

var bot = controller.spawn({
  token: process.env.BOT_API_KEY
}).startRTM();

var stations = void 0,
    reply = void 0;

controller.hears(['hello', 'hi', 'hallo', 'yo', 'ieps', 'hoi', 'hey', 'allo'], 'direct_message,direct_mention,mention', function (bot, message) {
  controller.storage.users.get(message.user, function (err, user) {
    if (user && user.name) {
      bot.reply(message, (0, _replies.REPLY_hello_user)(user.name));
    } else {
      bot.reply(message, _replies.REPLY_hello);
    }
  });
});

controller.hears(['shutdown'], 'direct_message,direct_mention,mention', function (bot, message) {

  bot.startConversation(message, function (err, convo) {

    convo.ask('Ben je zeker dat je me wilt afsluiten?', [{
      pattern: bot.utterances.yes,
      callback: function callback(response, convo) {
        convo.say('Salukes!');
        convo.next();
        setTimeout(function () {
          process.exit();
        }, 3000);
      }
    }, {
      pattern: bot.utterances.no,
      default: true,
      callback: function callback(response, convo) {
        convo.say('*Fiew!*');
        convo.next();
      }
    }]);
  });
});

controller.hears(['velo'], 'direct_message,direct_mention,mention', function (bot, message) {
  getVelokes(message);
});

/* Handle Velokes Replies */
var getVelokes = function getVelokes(message) {
  var automatic = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;


  (0, _nodeFetch2.default)('https://www.velo-antwerpen.be/availability_map/getJsonObject').then(function (res) {
    return res.json();
  }).then(function (json) {
    stations = json;

    var checks = handleChecks(message.text);
    checks = (0, _remove3.default)(checks, function (check) {
      return check !== 'velo' || check !== 'veloke';
    });

    stations = handleSelectStations(checks);
    handleStations(message, automatic);
  });
};

var handleChecks = function handleChecks(input) {

  if (input.includes(process.env.BASE_CAMP)) return process.env.BASE_STATIONS.split(', '); //check if the basecamp is called
  else return input.split(' ');
};

var handleSelectStations = function handleSelectStations(checks) {

  var selectedStations = [];

  stations.forEach(function (station) {
    checks.forEach(function (check) {

      check = (0, _toLower3.default)(check);
      var address = (0, _toLower3.default)(station.address);
      var name = (0, _toLower3.default)(station.name);
      if (address.includes(check) || name.includes(check)) selectedStations.push(station);
    });
  });

  return (0, _uniq3.default)(selectedStations);
};

/* check if there are multiple stations, 1 station or no stations */
var handleStations = function handleStations(message, automatic) {

  if (!(0, _isEmpty3.default)(stations)) {
    if (stations.length > 0) {
      handleReplies(stations, message, true, automatic);
    } else {
      handleReplies(stations, message, automatic);
    }
  } else {
    bot.reply(message, _replies.REPLY_no_stations);
  }
};

/* handle answers */
var handleReplies = function handleReplies(station, message) {
  var multipleStations = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
  var automatic = arguments[3];

  //automatic happens when a cron job is set

  if (multipleStations) {

    var stationsReply = handleMultipleStationsReply();
    if (automatic) handleAutomaticReply(stationsReply);else bot.reply(message, stationsReply);
  } else if (station.bikes > 0) {

    if (station.bikes < 5) {

      if (automatic) handleAutomaticReply((0, _replies.REPLY_almost_empty)(station.bikes, station.address));else bot.reply(message, (0, _replies.REPLY_almost_empty)(station.bikes, station.address));
    } else {

      if (automatic) handleAutomaticReply((0, _replies.REPLY_full)(station.bikes, station.address));else bot.reply(message, (0, _replies.REPLY_full)(station.bikes, station.address));
    }
  } else {

    if (automatic) handleAutomaticReply((0, _replies.REPLY_empty)(station.address));else bot.reply(message, (0, _replies.REPLY_empty)(station.address));
  }
};

var handleAutomaticReply = function handleAutomaticReply(reply) {
  bot.say({
    text: reply,
    channel: process.env.MAIN_CHANNEL
  });
};

var handleMultipleStationsReply = function handleMultipleStationsReply() {
  var _ref;

  var replies = [];
  stations.forEach(function (station) {
    replies.push((0, _replies.REPLY_more_stations)(station.bikes, station.address));
  });

  return (_ref = "").concat.apply(_ref, replies);
};

/* Cron Job */
var handleCronJob = function handleCronJob() {
  console.log('handle cron job');
  console.log(process.env.AUTO_TIMER);

  if (process.env.AUTO_TIMER) {

    var _job = new _cron.CronJob({
      cronTime: process.env.AUTO_TIMER,
      onTick: function onTick() {
        getVelokes({ text: process.env.BASE_CAMP }, true);
      },
      start: false,
      timeZone: 'Europe/Amsterdam'
    });

    _job.start();
  }

  console.log('job status', job.running);
};

handleCronJob();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5lczYiXSwibmFtZXMiOlsiY29udHJvbGxlciIsInNsYWNrYm90IiwiZGVidWciLCJib3QiLCJzcGF3biIsInRva2VuIiwicHJvY2VzcyIsImVudiIsIkJPVF9BUElfS0VZIiwic3RhcnRSVE0iLCJzdGF0aW9ucyIsInJlcGx5IiwiaGVhcnMiLCJtZXNzYWdlIiwic3RvcmFnZSIsInVzZXJzIiwiZ2V0IiwidXNlciIsImVyciIsIm5hbWUiLCJzdGFydENvbnZlcnNhdGlvbiIsImNvbnZvIiwiYXNrIiwicGF0dGVybiIsInV0dGVyYW5jZXMiLCJ5ZXMiLCJjYWxsYmFjayIsInJlc3BvbnNlIiwic2F5IiwibmV4dCIsInNldFRpbWVvdXQiLCJleGl0Iiwibm8iLCJkZWZhdWx0IiwiZ2V0VmVsb2tlcyIsImF1dG9tYXRpYyIsInRoZW4iLCJyZXMiLCJqc29uIiwiY2hlY2tzIiwiaGFuZGxlQ2hlY2tzIiwidGV4dCIsImNoZWNrIiwiaGFuZGxlU2VsZWN0U3RhdGlvbnMiLCJoYW5kbGVTdGF0aW9ucyIsImlucHV0IiwiaW5jbHVkZXMiLCJCQVNFX0NBTVAiLCJCQVNFX1NUQVRJT05TIiwic3BsaXQiLCJzZWxlY3RlZFN0YXRpb25zIiwiZm9yRWFjaCIsImFkZHJlc3MiLCJzdGF0aW9uIiwicHVzaCIsImxlbmd0aCIsImhhbmRsZVJlcGxpZXMiLCJtdWx0aXBsZVN0YXRpb25zIiwic3RhdGlvbnNSZXBseSIsImhhbmRsZU11bHRpcGxlU3RhdGlvbnNSZXBseSIsImhhbmRsZUF1dG9tYXRpY1JlcGx5IiwiYmlrZXMiLCJjaGFubmVsIiwiTUFJTl9DSEFOTkVMIiwicmVwbGllcyIsImNvbmNhdCIsImhhbmRsZUNyb25Kb2IiLCJjb25zb2xlIiwibG9nIiwiQVVUT19USU1FUiIsImpvYiIsImNyb25UaW1lIiwib25UaWNrIiwic3RhcnQiLCJ0aW1lWm9uZSIsInJ1bm5pbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBOzs7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aW1wb3J0IEJvdGtpdCBmcm9tICdib3RraXQnO1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IHt1bmlxLCB0b0xvd2VyLCByZW1vdmUsIGlzRW1wdHl9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge0Nyb25Kb2J9IGZyb20gJ2Nyb24nO1xuXG5pbXBvcnQge1JFUExZX2hlbGxvLFxuICAgICAgICBSRVBMWV9oZWxsb191c2VyLFxuICAgICAgICBSRVBMWV9mdWxsLFxuICAgICAgICBSRVBMWV9hbG1vc3RfZW1wdHksXG4gICAgICAgIFJFUExZX2VtcHR5LFxuICAgICAgICBSRVBMWV9ub19zdGF0aW9ucyxcbiAgICAgICAgUkVQTFlfbW9yZV9zdGF0aW9uc30gZnJvbSAnLi9zZXR0aW5ncy9yZXBsaWVzJztcblxuY29uc3QgY29udHJvbGxlciA9IEJvdGtpdC5zbGFja2JvdCh7XG4gICAgZGVidWc6IHRydWUsXG59KTtcblxuY29uc3QgYm90ID0gY29udHJvbGxlci5zcGF3bih7XG4gICAgdG9rZW46IHByb2Nlc3MuZW52LkJPVF9BUElfS0VZXG59KS5zdGFydFJUTSgpO1xuXG5sZXQgc3RhdGlvbnMsIHJlcGx5O1xuXG5jb250cm9sbGVyLmhlYXJzKFxuICBbJ2hlbGxvJywgJ2hpJywgJ2hhbGxvJywgJ3lvJywgJ2llcHMnLCAnaG9pJywgJ2hleScsICdhbGxvJ10sXG4gICdkaXJlY3RfbWVzc2FnZSxkaXJlY3RfbWVudGlvbixtZW50aW9uJyxcbiAgKGJvdCwgbWVzc2FnZSkgPT4ge1xuICAgIGNvbnRyb2xsZXIuc3RvcmFnZS51c2Vycy5nZXQobWVzc2FnZS51c2VyLCBmdW5jdGlvbihlcnIsIHVzZXIpIHtcbiAgICAgIGlmICh1c2VyICYmIHVzZXIubmFtZSkgeyBib3QucmVwbHkobWVzc2FnZSwgUkVQTFlfaGVsbG9fdXNlcih1c2VyLm5hbWUpKTtcbiAgICAgIH0gZWxzZSB7IGJvdC5yZXBseShtZXNzYWdlLCBSRVBMWV9oZWxsbyk7IH1cbiAgICB9KTtcbiAgfVxuKTtcblxuY29udHJvbGxlci5oZWFycyhcbiAgWydzaHV0ZG93biddLFxuICAnZGlyZWN0X21lc3NhZ2UsZGlyZWN0X21lbnRpb24sbWVudGlvbicsXG4gIChib3QsIG1lc3NhZ2UpID0+IHtcblxuICAgIGJvdC5zdGFydENvbnZlcnNhdGlvbihtZXNzYWdlLCBmdW5jdGlvbihlcnIsIGNvbnZvKSB7XG5cbiAgICAgICAgY29udm8uYXNrKCdCZW4gamUgemVrZXIgZGF0IGplIG1lIHdpbHQgYWZzbHVpdGVuPycsIFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBwYXR0ZXJuOiBib3QudXR0ZXJhbmNlcy55ZXMsXG4gICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKHJlc3BvbnNlLCBjb252bykge1xuICAgICAgICAgICAgICAgICAgICBjb252by5zYXkoJ1NhbHVrZXMhJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnZvLm5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgICAgICAgICAgICAgICAgICB9LCAzMDAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBwYXR0ZXJuOiBib3QudXR0ZXJhbmNlcy5ubyxcbiAgICAgICAgICAgIGRlZmF1bHQ6IHRydWUsXG4gICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24ocmVzcG9uc2UsIGNvbnZvKSB7XG4gICAgICAgICAgICAgICAgY29udm8uc2F5KCcqRmlldyEqJyk7XG4gICAgICAgICAgICAgICAgY29udm8ubmV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIF0pO1xuICAgIH0pO1xuICB9XG4pO1xuXG5jb250cm9sbGVyLmhlYXJzKFxuICBbJ3ZlbG8nXSxcbiAgJ2RpcmVjdF9tZXNzYWdlLGRpcmVjdF9tZW50aW9uLG1lbnRpb24nLFxuICAoYm90LCBtZXNzYWdlKSA9PiB7XG4gICAgZ2V0VmVsb2tlcyhtZXNzYWdlKTtcbiAgfVxuKTtcblxuLyogSGFuZGxlIFZlbG9rZXMgUmVwbGllcyAqL1xuY29uc3QgZ2V0VmVsb2tlcyA9IChtZXNzYWdlLCBhdXRvbWF0aWMgPSBmYWxzZSkgPT4ge1xuXG4gIGZldGNoKCdodHRwczovL3d3dy52ZWxvLWFudHdlcnBlbi5iZS9hdmFpbGFiaWxpdHlfbWFwL2dldEpzb25PYmplY3QnKVxuICAgIC50aGVuKGZ1bmN0aW9uKHJlcykge1xuICAgICAgcmV0dXJuIHJlcy5qc29uKCk7XG4gICAgfSlcbiAgICAudGhlbihmdW5jdGlvbihqc29uKSB7XG4gICAgICBzdGF0aW9ucyA9IGpzb247XG5cbiAgICAgIGxldCBjaGVja3MgPSBoYW5kbGVDaGVja3MobWVzc2FnZS50ZXh0KTtcbiAgICAgIGNoZWNrcyA9IHJlbW92ZShjaGVja3MsIGNoZWNrID0+IHtcbiAgICAgICAgcmV0dXJuIGNoZWNrICE9PSAndmVsbycgfHwgY2hlY2sgIT09ICd2ZWxva2UnO1xuICAgICAgfSk7XG5cbiAgICAgIHN0YXRpb25zID0gaGFuZGxlU2VsZWN0U3RhdGlvbnMoY2hlY2tzKTtcbiAgICAgIGhhbmRsZVN0YXRpb25zKG1lc3NhZ2UsIGF1dG9tYXRpYyk7XG4gICAgfSk7XG59O1xuXG5jb25zdCBoYW5kbGVDaGVja3MgPSAoaW5wdXQpID0+IHtcblxuICBpZihpbnB1dC5pbmNsdWRlcyhwcm9jZXNzLmVudi5CQVNFX0NBTVApKSByZXR1cm4gcHJvY2Vzcy5lbnYuQkFTRV9TVEFUSU9OUy5zcGxpdCgnLCAnKTsgLy9jaGVjayBpZiB0aGUgYmFzZWNhbXAgaXMgY2FsbGVkXG4gIGVsc2UgcmV0dXJuIGlucHV0LnNwbGl0KCcgJyk7XG59XG5cbmNvbnN0IGhhbmRsZVNlbGVjdFN0YXRpb25zID0gKGNoZWNrcykgPT4ge1xuXG4gIGNvbnN0IHNlbGVjdGVkU3RhdGlvbnMgPSBbXTtcblxuICBzdGF0aW9ucy5mb3JFYWNoKHN0YXRpb24gPT4ge1xuICAgIGNoZWNrcy5mb3JFYWNoKGNoZWNrID0+IHtcblxuICAgICAgY2hlY2sgPSB0b0xvd2VyKGNoZWNrKTtcbiAgICAgIGNvbnN0IGFkZHJlc3MgPSB0b0xvd2VyKHN0YXRpb24uYWRkcmVzcyk7XG4gICAgICBjb25zdCBuYW1lID0gdG9Mb3dlcihzdGF0aW9uLm5hbWUpO1xuICAgICAgaWYoYWRkcmVzcy5pbmNsdWRlcyhjaGVjaykgfHwgbmFtZS5pbmNsdWRlcyhjaGVjaykpIHNlbGVjdGVkU3RhdGlvbnMucHVzaChzdGF0aW9uKTtcblxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gdW5pcShzZWxlY3RlZFN0YXRpb25zKTtcbn07XG5cbi8qIGNoZWNrIGlmIHRoZXJlIGFyZSBtdWx0aXBsZSBzdGF0aW9ucywgMSBzdGF0aW9uIG9yIG5vIHN0YXRpb25zICovXG5jb25zdCBoYW5kbGVTdGF0aW9ucyA9IChtZXNzYWdlLCBhdXRvbWF0aWMpID0+IHtcblxuICBpZighaXNFbXB0eShzdGF0aW9ucykpIHtcbiAgICBpZihzdGF0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICBoYW5kbGVSZXBsaWVzKHN0YXRpb25zLCBtZXNzYWdlLCB0cnVlLCBhdXRvbWF0aWMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBoYW5kbGVSZXBsaWVzKHN0YXRpb25zLCBtZXNzYWdlLCBhdXRvbWF0aWMpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBib3QucmVwbHkobWVzc2FnZSwgUkVQTFlfbm9fc3RhdGlvbnMpO1xuICB9XG5cbn07XG5cbi8qIGhhbmRsZSBhbnN3ZXJzICovXG5jb25zdCBoYW5kbGVSZXBsaWVzID0gKHN0YXRpb24sIG1lc3NhZ2UsIG11bHRpcGxlU3RhdGlvbnMgPSBmYWxzZSwgYXV0b21hdGljKSA9PiB7XG4gIC8vYXV0b21hdGljIGhhcHBlbnMgd2hlbiBhIGNyb24gam9iIGlzIHNldFxuXG4gIGlmKG11bHRpcGxlU3RhdGlvbnMpIHtcblxuICAgIGNvbnN0IHN0YXRpb25zUmVwbHkgPSBoYW5kbGVNdWx0aXBsZVN0YXRpb25zUmVwbHkoKTtcbiAgICBpZihhdXRvbWF0aWMpIGhhbmRsZUF1dG9tYXRpY1JlcGx5KHN0YXRpb25zUmVwbHkpO1xuICAgIGVsc2UgYm90LnJlcGx5KG1lc3NhZ2UsIHN0YXRpb25zUmVwbHkpO1xuXG4gIH0gZWxzZSBpZihzdGF0aW9uLmJpa2VzID4gMCkge1xuXG4gICAgaWYoc3RhdGlvbi5iaWtlcyA8IDUpIHtcblxuICAgICAgaWYoYXV0b21hdGljKSBoYW5kbGVBdXRvbWF0aWNSZXBseShSRVBMWV9hbG1vc3RfZW1wdHkoc3RhdGlvbi5iaWtlcywgc3RhdGlvbi5hZGRyZXNzKSk7XG4gICAgICBlbHNlIGJvdC5yZXBseShtZXNzYWdlLCBSRVBMWV9hbG1vc3RfZW1wdHkoc3RhdGlvbi5iaWtlcywgc3RhdGlvbi5hZGRyZXNzKSApO1xuXG4gICAgfSBlbHNlIHtcblxuICAgICAgaWYoYXV0b21hdGljKSBoYW5kbGVBdXRvbWF0aWNSZXBseShSRVBMWV9mdWxsKHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykpO1xuICAgICAgZWxzZSBib3QucmVwbHkobWVzc2FnZSwgUkVQTFlfZnVsbChzdGF0aW9uLmJpa2VzLCBzdGF0aW9uLmFkZHJlc3MpICk7XG4gICAgfVxuXG4gIH0gZWxzZSB7XG5cbiAgICBpZihhdXRvbWF0aWMpIGhhbmRsZUF1dG9tYXRpY1JlcGx5KFJFUExZX2VtcHR5KHN0YXRpb24uYWRkcmVzcykpO1xuICAgIGVsc2UgYm90LnJlcGx5KG1lc3NhZ2UsIFJFUExZX2VtcHR5KHN0YXRpb24uYWRkcmVzcykgKTtcbiAgfVxufTtcblxuY29uc3QgaGFuZGxlQXV0b21hdGljUmVwbHkgPSByZXBseSA9PiB7XG4gIGJvdC5zYXkoe1xuICAgIHRleHQ6IHJlcGx5LFxuICAgIGNoYW5uZWw6IHByb2Nlc3MuZW52Lk1BSU5fQ0hBTk5FTFxuICB9KTtcbn1cblxuY29uc3QgaGFuZGxlTXVsdGlwbGVTdGF0aW9uc1JlcGx5ID0gKCkgPT4ge1xuICBjb25zdCByZXBsaWVzID0gW107XG4gIHN0YXRpb25zLmZvckVhY2goc3RhdGlvbiA9PiB7XG4gICAgcmVwbGllcy5wdXNoKFJFUExZX21vcmVfc3RhdGlvbnMoc3RhdGlvbi5iaWtlcywgc3RhdGlvbi5hZGRyZXNzKSk7XG4gIH0pO1xuXG4gIHJldHVybiBcIlwiLmNvbmNhdCguLi5yZXBsaWVzKTtcbn1cblxuLyogQ3JvbiBKb2IgKi9cbmNvbnN0IGhhbmRsZUNyb25Kb2IgPSAoKSA9PiB7XG4gIGNvbnNvbGUubG9nKCdoYW5kbGUgY3JvbiBqb2InKTtcbiAgY29uc29sZS5sb2cocHJvY2Vzcy5lbnYuQVVUT19USU1FUik7XG5cbiAgaWYocHJvY2Vzcy5lbnYuQVVUT19USU1FUikge1xuXG4gICAgY29uc3Qgam9iID0gbmV3IENyb25Kb2Ioe1xuICAgICAgY3JvblRpbWU6IHByb2Nlc3MuZW52LkFVVE9fVElNRVIsXG4gICAgICBvblRpY2s6IGZ1bmN0aW9uKCkge1xuICAgICAgICBnZXRWZWxva2VzKHt0ZXh0OiBwcm9jZXNzLmVudi5CQVNFX0NBTVB9LCB0cnVlKTtcbiAgICAgIH0sXG4gICAgICBzdGFydDogZmFsc2UsXG4gICAgICB0aW1lWm9uZTogJ0V1cm9wZS9BbXN0ZXJkYW0nXG4gICAgfSk7XG5cbiAgICBqb2Iuc3RhcnQoKTtcblxuICB9XG5cbiAgY29uc29sZS5sb2coJ2pvYiBzdGF0dXMnLCBqb2IucnVubmluZyk7XG59XG5cbmhhbmRsZUNyb25Kb2IoKTtcbiJdfQ==