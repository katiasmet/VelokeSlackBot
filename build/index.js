'use strict';

var _isEmpty2 = require('lodash/isEmpty');

var _isEmpty3 = _interopRequireDefault(_isEmpty2);

var _remove2 = require('lodash/remove');

var _remove3 = _interopRequireDefault(_remove2);

var _toLower2 = require('lodash/toLower');

var _toLower3 = _interopRequireDefault(_toLower2);

var _uniq2 = require('lodash/uniq');

var _uniq3 = _interopRequireDefault(_uniq2);

var _botkit = require('botkit');

var _botkit2 = _interopRequireDefault(_botkit);

var _nodeFetch = require('node-fetch');

var _nodeFetch2 = _interopRequireDefault(_nodeFetch);

var _cron = require('cron');

var _replies = require('./settings/replies');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

//D4NP461K6

var controller = _botkit2.default.slackbot({
  debug: true
});

var bot = controller.spawn({
  token: process.env.BOT_API_KEY
}).startRTM();

var stations = void 0,
    reply = void 0;

controller.hears(['hello', 'hi', 'hallo', 'yo', 'ieps', 'hoi', 'hey', 'allo'], 'direct_message,direct_mention,mention', function (bot, message) {
  controller.storage.users.get(message.user, function (err, user) {
    if (user && user.name) {
      bot.reply(message, (0, _replies.REPLY_hello_user)(user.name));
    } else {
      bot.reply(message, _replies.REPLY_hello);
    }
  });
});

controller.hears(['shutdown'], 'direct_message,direct_mention,mention', function (bot, message) {

  bot.startConversation(message, function (err, convo) {

    convo.ask('Ben je zeker dat je me wilt afsluiten?', [{
      pattern: bot.utterances.yes,
      callback: function callback(response, convo) {
        convo.say('Salukes!');
        convo.next();
        setTimeout(function () {
          process.exit();
        }, 3000);
      }
    }, {
      pattern: bot.utterances.no,
      default: true,
      callback: function callback(response, convo) {
        convo.say('*Fiew!*');
        convo.next();
      }
    }]);
  });
});

controller.hears(['velo'], 'direct_message,direct_mention,mention', function (bot, message) {
  getVelokes(message);
});

/* Handle Velokes Replies */
var getVelokes = function getVelokes(message) {
  var automatic = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;


  (0, _nodeFetch2.default)('https://www.velo-antwerpen.be/availability_map/getJsonObject').then(function (res) {
    return res.json();
  }).then(function (json) {
    stations = json;

    var checks = handleChecks(message.text);
    checks = (0, _remove3.default)(checks, function (check) {
      return check !== 'velo' || check !== 'veloke';
    });

    stations = handleSelectStations(checks);
    handleStations(message, automatic);
  });
};

var handleChecks = function handleChecks(input) {

  if (input.includes(process.env.BASE_CAMP)) return process.env.BASE_STATIONS.split(', '); //check if the basecamp is called
  else return input.split(' ');
};

var handleSelectStations = function handleSelectStations(checks) {

  var selectedStations = [];

  stations.forEach(function (station) {
    checks.forEach(function (check) {

      check = (0, _toLower3.default)(check);
      var address = (0, _toLower3.default)(station.address);
      var name = (0, _toLower3.default)(station.name);
      if (address.includes(check) || name.includes(check)) selectedStations.push(station);
    });
  });

  return (0, _uniq3.default)(selectedStations);
};

/* check if there are multiple stations, 1 station or no stations */
var handleStations = function handleStations(message, automatic) {

  if (!(0, _isEmpty3.default)(stations)) {
    if (stations.length > 0) {
      handleReplies(stations, message, true, automatic);
    } else {
      handleReplies(stations, message, automatic);
    }
  } else {
    bot.reply(message, _replies.REPLY_no_stations);
  }
};

/* handle answers */
var handleReplies = function handleReplies(station, message) {
  var multipleStations = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
  var automatic = arguments[3];

  //automatic happens when a cron job is set

  if (multipleStations) {

    var stationsReply = handleMultipleStationsReply();
    if (automatic) handleAutomaticReply(stationsReply);else bot.reply(message, stationsReply);
  } else if (station.bikes > 0) {

    if (station.bikes < 5) {

      if (automatic) handleAutomaticReply((0, _replies.REPLY_almost_empty)(station.bikes, station.address));else bot.reply(message, (0, _replies.REPLY_almost_empty)(station.bikes, station.address));
    } else {

      if (automatic) handleAutomaticReply((0, _replies.REPLY_full)(station.bikes, station.address));else bot.reply(message, (0, _replies.REPLY_full)(station.bikes, station.address));
    }
  } else {

    if (automatic) handleAutomaticReply((0, _replies.REPLY_empty)(station.address));else bot.reply(message, (0, _replies.REPLY_empty)(station.address));
  }
};

var handleAutomaticReply = function handleAutomaticReply(reply) {
  bot.say({
    text: reply,
    channel: process.env.MAIN_CHANNEL
  });
};

var handleMultipleStationsReply = function handleMultipleStationsReply() {
  var _ref;

  var replies = [];
  stations.forEach(function (station) {
    replies.push((0, _replies.REPLY_more_stations)(station.bikes, station.address));
  });

  return (_ref = "").concat.apply(_ref, replies);
};

/* Cron Job */
var handleCronJob = function handleCronJob() {

  if (process.env.AUTO_TIMER) {

    var job = new _cron.CronJob({
      cronTime: process.env.AUTO_TIMER,
      onTick: function onTick() {
        getVelokes({ text: process.env.BASE_CAMP }, true);
      },
      start: false,
      timeZone: 'Europe/Amsterdam'
    });

    job.start();
  }
};

handleCronJob();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5lczYiXSwibmFtZXMiOlsiY29udHJvbGxlciIsInNsYWNrYm90IiwiZGVidWciLCJib3QiLCJzcGF3biIsInRva2VuIiwicHJvY2VzcyIsImVudiIsIkJPVF9BUElfS0VZIiwic3RhcnRSVE0iLCJzdGF0aW9ucyIsInJlcGx5IiwiaGVhcnMiLCJtZXNzYWdlIiwic3RvcmFnZSIsInVzZXJzIiwiZ2V0IiwidXNlciIsImVyciIsIm5hbWUiLCJzdGFydENvbnZlcnNhdGlvbiIsImNvbnZvIiwiYXNrIiwicGF0dGVybiIsInV0dGVyYW5jZXMiLCJ5ZXMiLCJjYWxsYmFjayIsInJlc3BvbnNlIiwic2F5IiwibmV4dCIsInNldFRpbWVvdXQiLCJleGl0Iiwibm8iLCJkZWZhdWx0IiwiZ2V0VmVsb2tlcyIsImF1dG9tYXRpYyIsInRoZW4iLCJyZXMiLCJqc29uIiwiY2hlY2tzIiwiaGFuZGxlQ2hlY2tzIiwidGV4dCIsImNoZWNrIiwiaGFuZGxlU2VsZWN0U3RhdGlvbnMiLCJoYW5kbGVTdGF0aW9ucyIsImlucHV0IiwiaW5jbHVkZXMiLCJCQVNFX0NBTVAiLCJCQVNFX1NUQVRJT05TIiwic3BsaXQiLCJzZWxlY3RlZFN0YXRpb25zIiwiZm9yRWFjaCIsImFkZHJlc3MiLCJzdGF0aW9uIiwicHVzaCIsImxlbmd0aCIsImhhbmRsZVJlcGxpZXMiLCJtdWx0aXBsZVN0YXRpb25zIiwic3RhdGlvbnNSZXBseSIsImhhbmRsZU11bHRpcGxlU3RhdGlvbnNSZXBseSIsImhhbmRsZUF1dG9tYXRpY1JlcGx5IiwiYmlrZXMiLCJjaGFubmVsIiwiTUFJTl9DSEFOTkVMIiwicmVwbGllcyIsImNvbmNhdCIsImhhbmRsZUNyb25Kb2IiLCJBVVRPX1RJTUVSIiwiam9iIiwiY3JvblRpbWUiLCJvblRpY2siLCJzdGFydCIsInRpbWVab25lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBRUE7O0FBRUE7Ozs7QUFQ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Q0YsQ0EzQkQ7O0FBNkJBLElBQU1RLHVCQUF1QixTQUF2QkEsb0JBQXVCLFFBQVM7QUFDcEN6RCxNQUFJeUIsR0FBSixDQUFRO0FBQ05hLFVBQU05QixLQURBO0FBRU5tRCxhQUFTeEQsUUFBUUMsR0FBUixDQUFZd0Q7QUFGZixHQUFSO0FBSUQsQ0FMRDs7QUFPQSxJQUFNSiw4QkFBOEIsU0FBOUJBLDJCQUE4QixHQUFNO0FBQUE7O0FBQ3hDLE1BQU1LLFVBQVUsRUFBaEI7QUFDQXRELFdBQVN5QyxPQUFULENBQWlCLG1CQUFXO0FBQzFCYSxZQUFRVixJQUFSLENBQWEsa0NBQW9CRCxRQUFRUSxLQUE1QixFQUFtQ1IsUUFBUUQsT0FBM0MsQ0FBYjtBQUNELEdBRkQ7O0FBSUEsU0FBTyxZQUFHYSxNQUFILGFBQWFELE9BQWIsQ0FBUDtBQUNELENBUEQ7O0FBU0E7QUFDQSxJQUFNRSxnQkFBZ0IsU0FBaEJBLGFBQWdCLEdBQU07O0FBRTFCLE1BQUc1RCxRQUFRQyxHQUFSLENBQVk0RCxVQUFmLEVBQTJCOztBQUV6QixRQUFNQyxNQUFNLGtCQUFZO0FBQ3RCQyxnQkFBVS9ELFFBQVFDLEdBQVIsQ0FBWTRELFVBREE7QUFFdEJHLGNBQVEsa0JBQVc7QUFDakJwQyxtQkFBVyxFQUFDTyxNQUFNbkMsUUFBUUMsR0FBUixDQUFZd0MsU0FBbkIsRUFBWCxFQUEwQyxJQUExQztBQUNELE9BSnFCO0FBS3RCd0IsYUFBTyxLQUxlO0FBTXRCQyxnQkFBVTtBQU5ZLEtBQVosQ0FBWjs7QUFTQUosUUFBSUcsS0FBSjtBQUVEO0FBR0YsQ0FsQkQ7O0FBb0JBTCIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vRDROUDQ2MUs2XG5cbmltcG9ydCBCb3RraXQgZnJvbSAnYm90a2l0JztcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCB7dW5pcSwgdG9Mb3dlciwgcmVtb3ZlLCBpc0VtcHR5fSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHtDcm9uSm9ifSBmcm9tICdjcm9uJztcblxuaW1wb3J0IHtSRVBMWV9oZWxsbyxcbiAgICAgICAgUkVQTFlfaGVsbG9fdXNlcixcbiAgICAgICAgUkVQTFlfZnVsbCxcbiAgICAgICAgUkVQTFlfYWxtb3N0X2VtcHR5LFxuICAgICAgICBSRVBMWV9lbXB0eSxcbiAgICAgICAgUkVQTFlfbm9fc3RhdGlvbnMsXG4gICAgICAgIFJFUExZX21vcmVfc3RhdGlvbnN9IGZyb20gJy4vc2V0dGluZ3MvcmVwbGllcyc7XG5cbmNvbnN0IGNvbnRyb2xsZXIgPSBCb3RraXQuc2xhY2tib3Qoe1xuICAgIGRlYnVnOiB0cnVlLFxufSk7XG5cbmNvbnN0IGJvdCA9IGNvbnRyb2xsZXIuc3Bhd24oe1xuICAgIHRva2VuOiBwcm9jZXNzLmVudi5CT1RfQVBJX0tFWVxufSkuc3RhcnRSVE0oKTtcblxubGV0IHN0YXRpb25zLCByZXBseTtcblxuY29udHJvbGxlci5oZWFycyhcbiAgWydoZWxsbycsICdoaScsICdoYWxsbycsICd5bycsICdpZXBzJywgJ2hvaScsICdoZXknLCAnYWxsbyddLFxuICAnZGlyZWN0X21lc3NhZ2UsZGlyZWN0X21lbnRpb24sbWVudGlvbicsXG4gIChib3QsIG1lc3NhZ2UpID0+IHtcbiAgICBjb250cm9sbGVyLnN0b3JhZ2UudXNlcnMuZ2V0KG1lc3NhZ2UudXNlciwgZnVuY3Rpb24oZXJyLCB1c2VyKSB7XG4gICAgICBpZiAodXNlciAmJiB1c2VyLm5hbWUpIHsgYm90LnJlcGx5KG1lc3NhZ2UsIFJFUExZX2hlbGxvX3VzZXIodXNlci5uYW1lKSk7XG4gICAgICB9IGVsc2UgeyBib3QucmVwbHkobWVzc2FnZSwgUkVQTFlfaGVsbG8pOyB9XG4gICAgfSk7XG4gIH1cbik7XG5cbmNvbnRyb2xsZXIuaGVhcnMoXG4gIFsnc2h1dGRvd24nXSxcbiAgJ2RpcmVjdF9tZXNzYWdlLGRpcmVjdF9tZW50aW9uLG1lbnRpb24nLFxuICAoYm90LCBtZXNzYWdlKSA9PiB7XG5cbiAgICBib3Quc3RhcnRDb252ZXJzYXRpb24obWVzc2FnZSwgZnVuY3Rpb24oZXJyLCBjb252bykge1xuXG4gICAgICAgIGNvbnZvLmFzaygnQmVuIGplIHpla2VyIGRhdCBqZSBtZSB3aWx0IGFmc2x1aXRlbj8nLCBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcGF0dGVybjogYm90LnV0dGVyYW5jZXMueWVzLFxuICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihyZXNwb25zZSwgY29udm8pIHtcbiAgICAgICAgICAgICAgICAgICAgY29udm8uc2F5KCdTYWx1a2VzIScpO1xuICAgICAgICAgICAgICAgICAgICBjb252by5uZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMzAwMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgcGF0dGVybjogYm90LnV0dGVyYW5jZXMubm8sXG4gICAgICAgICAgICBkZWZhdWx0OiB0cnVlLFxuICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKHJlc3BvbnNlLCBjb252bykge1xuICAgICAgICAgICAgICAgIGNvbnZvLnNheSgnKkZpZXchKicpO1xuICAgICAgICAgICAgICAgIGNvbnZvLm5leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBdKTtcbiAgICB9KTtcbiAgfVxuKTtcblxuY29udHJvbGxlci5oZWFycyhcbiAgWyd2ZWxvJ10sXG4gICdkaXJlY3RfbWVzc2FnZSxkaXJlY3RfbWVudGlvbixtZW50aW9uJyxcbiAgKGJvdCwgbWVzc2FnZSkgPT4ge1xuICAgIGdldFZlbG9rZXMobWVzc2FnZSk7XG4gIH1cbik7XG5cbi8qIEhhbmRsZSBWZWxva2VzIFJlcGxpZXMgKi9cbmNvbnN0IGdldFZlbG9rZXMgPSAobWVzc2FnZSwgYXV0b21hdGljID0gZmFsc2UpID0+IHtcblxuICBmZXRjaCgnaHR0cHM6Ly93d3cudmVsby1hbnR3ZXJwZW4uYmUvYXZhaWxhYmlsaXR5X21hcC9nZXRKc29uT2JqZWN0JylcbiAgICAudGhlbihmdW5jdGlvbihyZXMpIHtcbiAgICAgIHJldHVybiByZXMuanNvbigpO1xuICAgIH0pXG4gICAgLnRoZW4oZnVuY3Rpb24oanNvbikge1xuICAgICAgc3RhdGlvbnMgPSBqc29uO1xuXG4gICAgICBsZXQgY2hlY2tzID0gaGFuZGxlQ2hlY2tzKG1lc3NhZ2UudGV4dCk7XG4gICAgICBjaGVja3MgPSByZW1vdmUoY2hlY2tzLCBjaGVjayA9PiB7XG4gICAgICAgIHJldHVybiBjaGVjayAhPT0gJ3ZlbG8nIHx8IGNoZWNrICE9PSAndmVsb2tlJztcbiAgICAgIH0pO1xuXG4gICAgICBzdGF0aW9ucyA9IGhhbmRsZVNlbGVjdFN0YXRpb25zKGNoZWNrcyk7XG4gICAgICBoYW5kbGVTdGF0aW9ucyhtZXNzYWdlLCBhdXRvbWF0aWMpO1xuICAgIH0pO1xufTtcblxuY29uc3QgaGFuZGxlQ2hlY2tzID0gKGlucHV0KSA9PiB7XG5cbiAgaWYoaW5wdXQuaW5jbHVkZXMocHJvY2Vzcy5lbnYuQkFTRV9DQU1QKSkgcmV0dXJuIHByb2Nlc3MuZW52LkJBU0VfU1RBVElPTlMuc3BsaXQoJywgJyk7IC8vY2hlY2sgaWYgdGhlIGJhc2VjYW1wIGlzIGNhbGxlZFxuICBlbHNlIHJldHVybiBpbnB1dC5zcGxpdCgnICcpO1xufVxuXG5jb25zdCBoYW5kbGVTZWxlY3RTdGF0aW9ucyA9IChjaGVja3MpID0+IHtcblxuICBjb25zdCBzZWxlY3RlZFN0YXRpb25zID0gW107XG5cbiAgc3RhdGlvbnMuZm9yRWFjaChzdGF0aW9uID0+IHtcbiAgICBjaGVja3MuZm9yRWFjaChjaGVjayA9PiB7XG5cbiAgICAgIGNoZWNrID0gdG9Mb3dlcihjaGVjayk7XG4gICAgICBjb25zdCBhZGRyZXNzID0gdG9Mb3dlcihzdGF0aW9uLmFkZHJlc3MpO1xuICAgICAgY29uc3QgbmFtZSA9IHRvTG93ZXIoc3RhdGlvbi5uYW1lKTtcbiAgICAgIGlmKGFkZHJlc3MuaW5jbHVkZXMoY2hlY2spIHx8IG5hbWUuaW5jbHVkZXMoY2hlY2spKSBzZWxlY3RlZFN0YXRpb25zLnB1c2goc3RhdGlvbik7XG5cbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIHVuaXEoc2VsZWN0ZWRTdGF0aW9ucyk7XG59O1xuXG4vKiBjaGVjayBpZiB0aGVyZSBhcmUgbXVsdGlwbGUgc3RhdGlvbnMsIDEgc3RhdGlvbiBvciBubyBzdGF0aW9ucyAqL1xuY29uc3QgaGFuZGxlU3RhdGlvbnMgPSAobWVzc2FnZSwgYXV0b21hdGljKSA9PiB7XG5cbiAgaWYoIWlzRW1wdHkoc3RhdGlvbnMpKSB7XG4gICAgaWYoc3RhdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgaGFuZGxlUmVwbGllcyhzdGF0aW9ucywgbWVzc2FnZSwgdHJ1ZSwgYXV0b21hdGljKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaGFuZGxlUmVwbGllcyhzdGF0aW9ucywgbWVzc2FnZSwgYXV0b21hdGljKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgYm90LnJlcGx5KG1lc3NhZ2UsIFJFUExZX25vX3N0YXRpb25zKTtcbiAgfVxuXG59O1xuXG4vKiBoYW5kbGUgYW5zd2VycyAqL1xuY29uc3QgaGFuZGxlUmVwbGllcyA9IChzdGF0aW9uLCBtZXNzYWdlLCBtdWx0aXBsZVN0YXRpb25zID0gZmFsc2UsIGF1dG9tYXRpYykgPT4ge1xuICAvL2F1dG9tYXRpYyBoYXBwZW5zIHdoZW4gYSBjcm9uIGpvYiBpcyBzZXRcblxuICBpZihtdWx0aXBsZVN0YXRpb25zKSB7XG5cbiAgICBjb25zdCBzdGF0aW9uc1JlcGx5ID0gaGFuZGxlTXVsdGlwbGVTdGF0aW9uc1JlcGx5KCk7XG4gICAgaWYoYXV0b21hdGljKSBoYW5kbGVBdXRvbWF0aWNSZXBseShzdGF0aW9uc1JlcGx5KTtcbiAgICBlbHNlIGJvdC5yZXBseShtZXNzYWdlLCBzdGF0aW9uc1JlcGx5KTtcblxuICB9IGVsc2UgaWYoc3RhdGlvbi5iaWtlcyA+IDApIHtcblxuICAgIGlmKHN0YXRpb24uYmlrZXMgPCA1KSB7XG5cbiAgICAgIGlmKGF1dG9tYXRpYykgaGFuZGxlQXV0b21hdGljUmVwbHkoUkVQTFlfYWxtb3N0X2VtcHR5KHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykpO1xuICAgICAgZWxzZSBib3QucmVwbHkobWVzc2FnZSwgUkVQTFlfYWxtb3N0X2VtcHR5KHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykgKTtcblxuICAgIH0gZWxzZSB7XG5cbiAgICAgIGlmKGF1dG9tYXRpYykgaGFuZGxlQXV0b21hdGljUmVwbHkoUkVQTFlfZnVsbChzdGF0aW9uLmJpa2VzLCBzdGF0aW9uLmFkZHJlc3MpKTtcbiAgICAgIGVsc2UgYm90LnJlcGx5KG1lc3NhZ2UsIFJFUExZX2Z1bGwoc3RhdGlvbi5iaWtlcywgc3RhdGlvbi5hZGRyZXNzKSApO1xuICAgIH1cblxuICB9IGVsc2Uge1xuXG4gICAgaWYoYXV0b21hdGljKSBoYW5kbGVBdXRvbWF0aWNSZXBseShSRVBMWV9lbXB0eShzdGF0aW9uLmFkZHJlc3MpKTtcbiAgICBlbHNlIGJvdC5yZXBseShtZXNzYWdlLCBSRVBMWV9lbXB0eShzdGF0aW9uLmFkZHJlc3MpICk7XG4gIH1cbn07XG5cbmNvbnN0IGhhbmRsZUF1dG9tYXRpY1JlcGx5ID0gcmVwbHkgPT4ge1xuICBib3Quc2F5KHtcbiAgICB0ZXh0OiByZXBseSxcbiAgICBjaGFubmVsOiBwcm9jZXNzLmVudi5NQUlOX0NIQU5ORUxcbiAgfSk7XG59XG5cbmNvbnN0IGhhbmRsZU11bHRpcGxlU3RhdGlvbnNSZXBseSA9ICgpID0+IHtcbiAgY29uc3QgcmVwbGllcyA9IFtdO1xuICBzdGF0aW9ucy5mb3JFYWNoKHN0YXRpb24gPT4ge1xuICAgIHJlcGxpZXMucHVzaChSRVBMWV9tb3JlX3N0YXRpb25zKHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykpO1xuICB9KTtcblxuICByZXR1cm4gXCJcIi5jb25jYXQoLi4ucmVwbGllcyk7XG59XG5cbi8qIENyb24gSm9iICovXG5jb25zdCBoYW5kbGVDcm9uSm9iID0gKCkgPT4ge1xuXG4gIGlmKHByb2Nlc3MuZW52LkFVVE9fVElNRVIpIHtcblxuICAgIGNvbnN0IGpvYiA9IG5ldyBDcm9uSm9iKHtcbiAgICAgIGNyb25UaW1lOiBwcm9jZXNzLmVudi5BVVRPX1RJTUVSLFxuICAgICAgb25UaWNrOiBmdW5jdGlvbigpIHtcbiAgICAgICAgZ2V0VmVsb2tlcyh7dGV4dDogcHJvY2Vzcy5lbnYuQkFTRV9DQU1QfSwgdHJ1ZSk7XG4gICAgICB9LFxuICAgICAgc3RhcnQ6IGZhbHNlLFxuICAgICAgdGltZVpvbmU6ICdFdXJvcGUvQW1zdGVyZGFtJ1xuICAgIH0pO1xuXG4gICAgam9iLnN0YXJ0KCk7XG5cbiAgfVxuXG5cbn1cblxuaGFuZGxlQ3JvbkpvYigpO1xuIl19