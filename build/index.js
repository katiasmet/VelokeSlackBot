'use strict';

var _isEmpty2 = require('lodash/isEmpty');

var _isEmpty3 = _interopRequireDefault(_isEmpty2);

var _remove2 = require('lodash/remove');

var _remove3 = _interopRequireDefault(_remove2);

var _toLower2 = require('lodash/toLower');

var _toLower3 = _interopRequireDefault(_toLower2);

var _uniq2 = require('lodash/uniq');

var _uniq3 = _interopRequireDefault(_uniq2);

var _botkit = require('botkit');

var _botkit2 = _interopRequireDefault(_botkit);

var _nodeFetch = require('node-fetch');

var _nodeFetch2 = _interopRequireDefault(_nodeFetch);

var _cron = require('cron');

var _replies = require('./settings/replies');

var _drunk_replies = require('./settings/drunk_replies');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var controller = _botkit2.default.slackbot({
  debug: true
}); //D4NP461K6

var bot = controller.spawn({
  token: process.env.BOT_API_KEY
}).startRTM();

var stations = void 0,
    reply = void 0;
var drunkFriday = false;

controller.hears(['hello', 'hi', 'hallo', 'yo', 'ieps', 'hoi', 'hey', 'allo'], 'direct_message,direct_mention,mention', function (bot, message) {
  controller.storage.users.get(message.user, function (err, user) {
    if (user && user.name) {
      drunkFriday ? bot.reply(message, (0, _drunk_replies.DRUNK_REPLY_hello_user)(user.name)) : bot.reply(message, (0, _replies.REPLY_hello_user)(user.name));
    } else {
      drunkFriday ? bot.reply(message, _drunk_replies.DRUNK_REPLY_hello) : bot.reply(message, _replies.REPLY_hello);
    }
  });
});

controller.hears(['shutdown'], 'direct_message,direct_mention,mention', function (bot, message) {

  bot.startConversation(message, function (err, convo) {

    convo.ask('Ben je zeker dat je me wilt afsluiten?', [{
      pattern: bot.utterances.yes,
      callback: function callback(response, convo) {
        convo.say('Salukes!');
        convo.next();
        setTimeout(function () {
          process.exit();
        }, 3000);
      }
    }, {
      pattern: bot.utterances.no,
      default: true,
      callback: function callback(response, convo) {
        convo.say('*Fiew!*');
        convo.next();
      }
    }]);
  });
});

controller.hears(['velo'], 'direct_message,direct_mention,mention', function (bot, message) {
  getVelokes(message);
});

/* Handle Velokes Replies */
var getVelokes = function getVelokes(message) {
  var automatic = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;


  (0, _nodeFetch2.default)('https://www.velo-antwerpen.be/availability_map/getJsonObject').then(function (res) {
    return res.json();
  }).then(function (json) {
    stations = json;

    var checks = handleChecks(message.text);
    checks = (0, _remove3.default)(checks, function (check) {
      return check !== 'velo' || check !== 'veloke';
    });

    stations = handleSelectStations(checks);
    handleStations(message, automatic);
  });
};

var handleChecks = function handleChecks(input) {

  if (input.includes(process.env.BASE_CAMP)) return process.env.BASE_STATIONS.split(', '); //check if the basecamp is called
  else return input.split(' ');
};

var handleSelectStations = function handleSelectStations(checks) {

  var selectedStations = [];

  stations.forEach(function (station) {
    checks.forEach(function (check) {

      check = (0, _toLower3.default)(check);
      var address = (0, _toLower3.default)(station.address);
      var name = (0, _toLower3.default)(station.name);
      if (address.includes(check) || name.includes(check)) selectedStations.push(station);
    });
  });

  return (0, _uniq3.default)(selectedStations);
};

/* check if there are multiple stations, 1 station or no stations */
var handleStations = function handleStations(message, automatic) {

  if (!(0, _isEmpty3.default)(stations)) {
    if (stations.length > 1) handleReplies(stations, message, true, automatic);else handleReplies(stations[0], message, automatic);
  } else {
    drunkFriday ? bot.reply(message, _drunk_replies.DRUNK_REPLY_no_stations) : bot.reply(message, _replies.REPLY_no_stations);
  }
};

/* handle answers */
var handleReplies = function handleReplies(station, message) {
  var multipleStations = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
  var automatic = arguments[3];

  //automatic happens when a cron job is set

  if (multipleStations) {

    var stationsReply = handleMultipleStationsReply();
    if (automatic) handleAutomaticReply(stationsReply);else bot.reply(message, stationsReply);
  } else if (station.bikes > 0) {

    if (station.bikes < 5) {

      if (automatic) {
        drunkFriday ? handleAutomaticReply((0, _drunk_replies.DRUNK_REPLY_almost_empty)(station.bikes, station.address)) : handleAutomaticReply((0, _replies.REPLY_almost_empty)(station.bikes, station.address));
      } else {
        drunkFriday ? bot.reply(message, (0, _drunk_replies.DRUNK_REPLY_almost_empty)(station.bikes, station.address)) : bot.reply(message, (0, _replies.REPLY_almost_empty)(station.bikes, station.address));
      };
    } else {

      if (automatic) {
        drunkFriday ? handleAutomaticReply((0, _drunk_replies.DRUNK_REPLY_full)(station.bikes, station.address)) : handleAutomaticReply((0, _replies.REPLY_full)(station.bikes, station.address));
      } else {
        drunkFriday ? bot.reply(message, (0, _drunk_replies.DRUNK_REPLY_full)(station.bikes, station.address)) : bot.reply(message, (0, _replies.REPLY_full)(station.bikes, station.address));
      };
    }
  } else {

    if (automatic) {
      drunkFriday ? handleAutomaticReply((0, _drunk_replies.DRUNK_REPLY_empty)(station.address)) : handleAutomaticReply((0, _replies.REPLY_empty)(station.address));
    } else {
      drunkFriday ? bot.reply(message, (0, _drunk_replies.DRUNK_REPLY_empty)(station.address)) : bot.reply(message, (0, _replies.REPLY_empty)(station.address));
    };
  }
};

var handleAutomaticReply = function handleAutomaticReply(reply) {
  bot.say({
    text: reply,
    channel: process.env.MAIN_CHANNEL
  });
};

var handleMultipleStationsReply = function handleMultipleStationsReply() {
  var _ref;

  var replies = [];
  stations.forEach(function (station) {
    drunkFriday ? replies.push((0, _drunk_replies.DRUNK_REPLY_more_stations)(station.bikes, station.address)) : replies.push((0, _replies.REPLY_more_stations)(station.bikes, station.address));
  });

  return (_ref = "").concat.apply(_ref, replies);
};

/* Cron Job */
var handleCronJobs = function handleCronJobs() {

  handleDailyUpdate();
  handleDrunkFriday();
};

var handleDailyUpdate = function handleDailyUpdate() {
  if (process.env.AUTO_TIMER) {

    var job = new _cron.CronJob({
      cronTime: process.env.AUTO_TIMER,
      onTick: function onTick() {
        getVelokes({ text: process.env.BASE_CAMP }, true);
      },
      start: false,
      timeZone: 'Europe/Amsterdam'
    });

    job.start();
  }
};

var handleDrunkFriday = function handleDrunkFriday() {
  var job = new _cron.CronJob({
    cronTime: '* * * * * 5',
    onTick: function onTick() {
      drunkFriday = true;
    },
    start: false,
    timeZone: 'Europe/Amsterdam'
  });

  job.start();
};

handleCronJobs();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5lczYiXSwibmFtZXMiOlsiY29udHJvbGxlciIsInNsYWNrYm90IiwiZGVidWciLCJib3QiLCJzcGF3biIsInRva2VuIiwicHJvY2VzcyIsImVudiIsIkJPVF9BUElfS0VZIiwic3RhcnRSVE0iLCJzdGF0aW9ucyIsInJlcGx5IiwiZHJ1bmtGcmlkYXkiLCJoZWFycyIsIm1lc3NhZ2UiLCJzdG9yYWdlIiwidXNlcnMiLCJnZXQiLCJ1c2VyIiwiZXJyIiwibmFtZSIsInN0YXJ0Q29udmVyc2F0aW9uIiwiY29udm8iLCJhc2siLCJwYXR0ZXJuIiwidXR0ZXJhbmNlcyIsInllcyIsImNhbGxiYWNrIiwicmVzcG9uc2UiLCJzYXkiLCJuZXh0Iiwic2V0VGltZW91dCIsImV4aXQiLCJubyIsImRlZmF1bHQiLCJnZXRWZWxva2VzIiwiYXV0b21hdGljIiwidGhlbiIsInJlcyIsImpzb24iLCJjaGVja3MiLCJoYW5kbGVDaGVja3MiLCJ0ZXh0IiwiY2hlY2siLCJoYW5kbGVTZWxlY3RTdGF0aW9ucyIsImhhbmRsZVN0YXRpb25zIiwiaW5wdXQiLCJpbmNsdWRlcyIsIkJBU0VfQ0FNUCIsIkJBU0VfU1RBVElPTlMiLCJzcGxpdCIsInNlbGVjdGVkU3RhdGlvbnMiLCJmb3JFYWNoIiwiYWRkcmVzcyIsInN0YXRpb24iLCJwdXNoIiwibGVuZ3RoIiwiaGFuZGxlUmVwbGllcyIsIm11bHRpcGxlU3RhdGlvbnMiLCJzdGF0aW9uc1JlcGx5IiwiaGFuZGxlTXVsdGlwbGVTdGF0aW9uc1JlcGx5IiwiaGFuZGxlQXV0b21hdGljUmVwbHkiLCJiaWtlcyIsImNoYW5uZWwiLCJNQUlOX0NIQU5ORUwiLCJyZXBsaWVzIiwiY29uY2F0IiwiaGFuZGxlQ3JvbkpvYnMiLCJoYW5kbGVEYWlseVVwZGF0ZSIsImhhbmRsZURydW5rRnJpZGF5IiwiQVVUT19USU1FUiIsImpvYiIsImNyb25UaW1lIiwib25UaWNrIiwic3RhcnQiLCJ0aW1lWm9uZSJdLCJtYXBwaW5n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QUFOWSxHQUFaLENBQVo7O0FBU0FKLE1BQUlHLEtBQUo7QUFFRCxDQVpEOztBQWNBUCIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vRDROUDQ2MUs2XG5cbmltcG9ydCBCb3RraXQgZnJvbSAnYm90a2l0JztcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCB7dW5pcSwgdG9Mb3dlciwgcmVtb3ZlLCBpc0VtcHR5fSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHtDcm9uSm9ifSBmcm9tICdjcm9uJztcblxuaW1wb3J0IHtSRVBMWV9oZWxsbyxcbiAgICAgICAgUkVQTFlfaGVsbG9fdXNlcixcbiAgICAgICAgUkVQTFlfZnVsbCxcbiAgICAgICAgUkVQTFlfYWxtb3N0X2VtcHR5LFxuICAgICAgICBSRVBMWV9lbXB0eSxcbiAgICAgICAgUkVQTFlfbm9fc3RhdGlvbnMsXG4gICAgICAgIFJFUExZX21vcmVfc3RhdGlvbnN9IGZyb20gJy4vc2V0dGluZ3MvcmVwbGllcyc7XG5cbmltcG9ydCB7RFJVTktfUkVQTFlfaGVsbG8sXG4gICAgICAgIERSVU5LX1JFUExZX2hlbGxvX3VzZXIsXG4gICAgICAgIERSVU5LX1JFUExZX2Z1bGwsXG4gICAgICAgIERSVU5LX1JFUExZX2FsbW9zdF9lbXB0eSxcbiAgICAgICAgRFJVTktfUkVQTFlfZW1wdHksXG4gICAgICAgIERSVU5LX1JFUExZX25vX3N0YXRpb25zLFxuICAgICAgICBEUlVOS19SRVBMWV9tb3JlX3N0YXRpb25zfSBmcm9tICcuL3NldHRpbmdzL2RydW5rX3JlcGxpZXMnO1xuXG5jb25zdCBjb250cm9sbGVyID0gQm90a2l0LnNsYWNrYm90KHtcbiAgICBkZWJ1ZzogdHJ1ZSxcbn0pO1xuXG5jb25zdCBib3QgPSBjb250cm9sbGVyLnNwYXduKHtcbiAgICB0b2tlbjogcHJvY2Vzcy5lbnYuQk9UX0FQSV9LRVlcbn0pLnN0YXJ0UlRNKCk7XG5cbmxldCBzdGF0aW9ucywgcmVwbHk7XG5sZXQgZHJ1bmtGcmlkYXkgPSBmYWxzZTtcblxuY29udHJvbGxlci5oZWFycyhcbiAgWydoZWxsbycsICdoaScsICdoYWxsbycsICd5bycsICdpZXBzJywgJ2hvaScsICdoZXknLCAnYWxsbyddLFxuICAnZGlyZWN0X21lc3NhZ2UsZGlyZWN0X21lbnRpb24sbWVudGlvbicsXG4gIChib3QsIG1lc3NhZ2UpID0+IHtcbiAgICBjb250cm9sbGVyLnN0b3JhZ2UudXNlcnMuZ2V0KG1lc3NhZ2UudXNlciwgZnVuY3Rpb24oZXJyLCB1c2VyKSB7XG4gICAgICBpZiAodXNlciAmJiB1c2VyLm5hbWUpIHtcbiAgICAgICAgZHJ1bmtGcmlkYXkgPyBib3QucmVwbHkobWVzc2FnZSwgRFJVTktfUkVQTFlfaGVsbG9fdXNlcih1c2VyLm5hbWUpKSA6IGJvdC5yZXBseShtZXNzYWdlLCBSRVBMWV9oZWxsb191c2VyKHVzZXIubmFtZSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZHJ1bmtGcmlkYXkgPyBib3QucmVwbHkobWVzc2FnZSwgRFJVTktfUkVQTFlfaGVsbG8pIDogYm90LnJlcGx5KG1lc3NhZ2UsIFJFUExZX2hlbGxvKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuKTtcblxuY29udHJvbGxlci5oZWFycyhcbiAgWydzaHV0ZG93biddLFxuICAnZGlyZWN0X21lc3NhZ2UsZGlyZWN0X21lbnRpb24sbWVudGlvbicsXG4gIChib3QsIG1lc3NhZ2UpID0+IHtcblxuICAgIGJvdC5zdGFydENvbnZlcnNhdGlvbihtZXNzYWdlLCBmdW5jdGlvbihlcnIsIGNvbnZvKSB7XG5cbiAgICAgICAgY29udm8uYXNrKCdCZW4gamUgemVrZXIgZGF0IGplIG1lIHdpbHQgYWZzbHVpdGVuPycsIFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBwYXR0ZXJuOiBib3QudXR0ZXJhbmNlcy55ZXMsXG4gICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKHJlc3BvbnNlLCBjb252bykge1xuICAgICAgICAgICAgICAgICAgICBjb252by5zYXkoJ1NhbHVrZXMhJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnZvLm5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgICAgICAgICAgICAgICAgICB9LCAzMDAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBwYXR0ZXJuOiBib3QudXR0ZXJhbmNlcy5ubyxcbiAgICAgICAgICAgIGRlZmF1bHQ6IHRydWUsXG4gICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24ocmVzcG9uc2UsIGNvbnZvKSB7XG4gICAgICAgICAgICAgICAgY29udm8uc2F5KCcqRmlldyEqJyk7XG4gICAgICAgICAgICAgICAgY29udm8ubmV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIF0pO1xuICAgIH0pO1xuICB9XG4pO1xuXG5jb250cm9sbGVyLmhlYXJzKFxuICBbJ3ZlbG8nXSxcbiAgJ2RpcmVjdF9tZXNzYWdlLGRpcmVjdF9tZW50aW9uLG1lbnRpb24nLFxuICAoYm90LCBtZXNzYWdlKSA9PiB7XG4gICAgZ2V0VmVsb2tlcyhtZXNzYWdlKTtcbiAgfVxuKTtcblxuLyogSGFuZGxlIFZlbG9rZXMgUmVwbGllcyAqL1xuY29uc3QgZ2V0VmVsb2tlcyA9IChtZXNzYWdlLCBhdXRvbWF0aWMgPSBmYWxzZSkgPT4ge1xuXG4gIGZldGNoKCdodHRwczovL3d3dy52ZWxvLWFudHdlcnBlbi5iZS9hdmFpbGFiaWxpdHlfbWFwL2dldEpzb25PYmplY3QnKVxuICAgIC50aGVuKGZ1bmN0aW9uKHJlcykge1xuICAgICAgcmV0dXJuIHJlcy5qc29uKCk7XG4gICAgfSlcbiAgICAudGhlbihmdW5jdGlvbihqc29uKSB7XG4gICAgICBzdGF0aW9ucyA9IGpzb247XG5cbiAgICAgIGxldCBjaGVja3MgPSBoYW5kbGVDaGVja3MobWVzc2FnZS50ZXh0KTtcbiAgICAgIGNoZWNrcyA9IHJlbW92ZShjaGVja3MsIGNoZWNrID0+IHtcbiAgICAgICAgcmV0dXJuIGNoZWNrICE9PSAndmVsbycgfHwgY2hlY2sgIT09ICd2ZWxva2UnO1xuICAgICAgfSk7XG5cbiAgICAgIHN0YXRpb25zID0gaGFuZGxlU2VsZWN0U3RhdGlvbnMoY2hlY2tzKTtcbiAgICAgIGhhbmRsZVN0YXRpb25zKG1lc3NhZ2UsIGF1dG9tYXRpYyk7XG4gICAgfSk7XG59O1xuXG5jb25zdCBoYW5kbGVDaGVja3MgPSAoaW5wdXQpID0+IHtcblxuICBpZihpbnB1dC5pbmNsdWRlcyhwcm9jZXNzLmVudi5CQVNFX0NBTVApKSByZXR1cm4gcHJvY2Vzcy5lbnYuQkFTRV9TVEFUSU9OUy5zcGxpdCgnLCAnKTsgLy9jaGVjayBpZiB0aGUgYmFzZWNhbXAgaXMgY2FsbGVkXG4gIGVsc2UgcmV0dXJuIGlucHV0LnNwbGl0KCcgJyk7XG59XG5cbmNvbnN0IGhhbmRsZVNlbGVjdFN0YXRpb25zID0gKGNoZWNrcykgPT4ge1xuXG4gIGNvbnN0IHNlbGVjdGVkU3RhdGlvbnMgPSBbXTtcblxuICBzdGF0aW9ucy5mb3JFYWNoKHN0YXRpb24gPT4ge1xuICAgIGNoZWNrcy5mb3JFYWNoKGNoZWNrID0+IHtcblxuICAgICAgY2hlY2sgPSB0b0xvd2VyKGNoZWNrKTtcbiAgICAgIGNvbnN0IGFkZHJlc3MgPSB0b0xvd2VyKHN0YXRpb24uYWRkcmVzcyk7XG4gICAgICBjb25zdCBuYW1lID0gdG9Mb3dlcihzdGF0aW9uLm5hbWUpO1xuICAgICAgaWYoYWRkcmVzcy5pbmNsdWRlcyhjaGVjaykgfHwgbmFtZS5pbmNsdWRlcyhjaGVjaykpIHNlbGVjdGVkU3RhdGlvbnMucHVzaChzdGF0aW9uKTtcblxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gdW5pcShzZWxlY3RlZFN0YXRpb25zKTtcbn07XG5cbi8qIGNoZWNrIGlmIHRoZXJlIGFyZSBtdWx0aXBsZSBzdGF0aW9ucywgMSBzdGF0aW9uIG9yIG5vIHN0YXRpb25zICovXG5jb25zdCBoYW5kbGVTdGF0aW9ucyA9IChtZXNzYWdlLCBhdXRvbWF0aWMpID0+IHtcblxuICBpZighaXNFbXB0eShzdGF0aW9ucykpIHtcbiAgICBpZihzdGF0aW9ucy5sZW5ndGggPiAxKSBoYW5kbGVSZXBsaWVzKHN0YXRpb25zLCBtZXNzYWdlLCB0cnVlLCBhdXRvbWF0aWMpO1xuICAgIGVsc2UgaGFuZGxlUmVwbGllcyhzdGF0aW9uc1swXSwgbWVzc2FnZSwgYXV0b21hdGljKTtcbiAgfSBlbHNlIHtcbiAgICBkcnVua0ZyaWRheSA/IGJvdC5yZXBseShtZXNzYWdlLCBEUlVOS19SRVBMWV9ub19zdGF0aW9ucykgOiBib3QucmVwbHkobWVzc2FnZSwgUkVQTFlfbm9fc3RhdGlvbnMpO1xuICB9XG5cbn07XG5cbi8qIGhhbmRsZSBhbnN3ZXJzICovXG5jb25zdCBoYW5kbGVSZXBsaWVzID0gKHN0YXRpb24sIG1lc3NhZ2UsIG11bHRpcGxlU3RhdGlvbnMgPSBmYWxzZSwgYXV0b21hdGljKSA9PiB7XG4gIC8vYXV0b21hdGljIGhhcHBlbnMgd2hlbiBhIGNyb24gam9iIGlzIHNldFxuXG4gIGlmKG11bHRpcGxlU3RhdGlvbnMpIHtcblxuICAgIGNvbnN0IHN0YXRpb25zUmVwbHkgPSBoYW5kbGVNdWx0aXBsZVN0YXRpb25zUmVwbHkoKTtcbiAgICBpZihhdXRvbWF0aWMpIGhhbmRsZUF1dG9tYXRpY1JlcGx5KHN0YXRpb25zUmVwbHkpO1xuICAgIGVsc2UgYm90LnJlcGx5KG1lc3NhZ2UsIHN0YXRpb25zUmVwbHkpO1xuXG4gIH0gZWxzZSBpZihzdGF0aW9uLmJpa2VzID4gMCkge1xuXG4gICAgaWYoc3RhdGlvbi5iaWtlcyA8IDUpIHtcblxuICAgICAgaWYoYXV0b21hdGljKSB7XG4gICAgICAgIGRydW5rRnJpZGF5ID8gaGFuZGxlQXV0b21hdGljUmVwbHkoRFJVTktfUkVQTFlfYWxtb3N0X2VtcHR5KHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykpIDogaGFuZGxlQXV0b21hdGljUmVwbHkoUkVQTFlfYWxtb3N0X2VtcHR5KHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZHJ1bmtGcmlkYXkgPyBib3QucmVwbHkobWVzc2FnZSwgRFJVTktfUkVQTFlfYWxtb3N0X2VtcHR5KHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykpIDogYm90LnJlcGx5KG1lc3NhZ2UsIFJFUExZX2FsbW9zdF9lbXB0eShzdGF0aW9uLmJpa2VzLCBzdGF0aW9uLmFkZHJlc3MpKTtcbiAgICAgIH07XG5cbiAgICB9IGVsc2Uge1xuXG4gICAgICBpZihhdXRvbWF0aWMpIHtcbiAgICAgICAgZHJ1bmtGcmlkYXkgPyBoYW5kbGVBdXRvbWF0aWNSZXBseShEUlVOS19SRVBMWV9mdWxsKHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykpIDogaGFuZGxlQXV0b21hdGljUmVwbHkoUkVQTFlfZnVsbChzdGF0aW9uLmJpa2VzLCBzdGF0aW9uLmFkZHJlc3MpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRydW5rRnJpZGF5ID8gYm90LnJlcGx5KG1lc3NhZ2UsIERSVU5LX1JFUExZX2Z1bGwoc3RhdGlvbi5iaWtlcywgc3RhdGlvbi5hZGRyZXNzKSkgOiBib3QucmVwbHkobWVzc2FnZSwgUkVQTFlfZnVsbChzdGF0aW9uLmJpa2VzLCBzdGF0aW9uLmFkZHJlc3MpKTtcbiAgICAgIH07XG4gICAgfVxuXG4gIH0gZWxzZSB7XG5cbiAgICBpZihhdXRvbWF0aWMpIHtcbiAgICAgIGRydW5rRnJpZGF5ID8gaGFuZGxlQXV0b21hdGljUmVwbHkoRFJVTktfUkVQTFlfZW1wdHkoc3RhdGlvbi5hZGRyZXNzKSkgOiBoYW5kbGVBdXRvbWF0aWNSZXBseShSRVBMWV9lbXB0eShzdGF0aW9uLmFkZHJlc3MpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZHJ1bmtGcmlkYXkgPyBib3QucmVwbHkobWVzc2FnZSwgRFJVTktfUkVQTFlfZW1wdHkoc3RhdGlvbi5hZGRyZXNzKSkgOiBib3QucmVwbHkobWVzc2FnZSwgUkVQTFlfZW1wdHkoc3RhdGlvbi5hZGRyZXNzKSk7XG4gICAgfTtcbiAgfVxufTtcblxuY29uc3QgaGFuZGxlQXV0b21hdGljUmVwbHkgPSByZXBseSA9PiB7XG4gIGJvdC5zYXkoe1xuICAgIHRleHQ6IHJlcGx5LFxuICAgIGNoYW5uZWw6IHByb2Nlc3MuZW52Lk1BSU5fQ0hBTk5FTFxuICB9KTtcbn1cblxuY29uc3QgaGFuZGxlTXVsdGlwbGVTdGF0aW9uc1JlcGx5ID0gKCkgPT4ge1xuICBjb25zdCByZXBsaWVzID0gW107XG4gIHN0YXRpb25zLmZvckVhY2goc3RhdGlvbiA9PiB7XG4gICAgZHJ1bmtGcmlkYXkgPyByZXBsaWVzLnB1c2goRFJVTktfUkVQTFlfbW9yZV9zdGF0aW9ucyhzdGF0aW9uLmJpa2VzLCBzdGF0aW9uLmFkZHJlc3MpKSA6IHJlcGxpZXMucHVzaChSRVBMWV9tb3JlX3N0YXRpb25zKHN0YXRpb24uYmlrZXMsIHN0YXRpb24uYWRkcmVzcykpO1xuICB9KTtcblxuICByZXR1cm4gXCJcIi5jb25jYXQoLi4ucmVwbGllcyk7XG59XG5cbi8qIENyb24gSm9iICovXG5jb25zdCBoYW5kbGVDcm9uSm9icyA9ICgpID0+IHtcblxuICBoYW5kbGVEYWlseVVwZGF0ZSgpO1xuICBoYW5kbGVEcnVua0ZyaWRheSgpO1xuXG59XG5cbmNvbnN0IGhhbmRsZURhaWx5VXBkYXRlID0gKCkgPT4ge1xuICBpZihwcm9jZXNzLmVudi5BVVRPX1RJTUVSKSB7XG5cbiAgICBjb25zdCBqb2IgPSBuZXcgQ3JvbkpvYih7XG4gICAgICBjcm9uVGltZTogcHJvY2Vzcy5lbnYuQVVUT19USU1FUixcbiAgICAgIG9uVGljazogZnVuY3Rpb24oKSB7XG4gICAgICAgIGdldFZlbG9rZXMoe3RleHQ6IHByb2Nlc3MuZW52LkJBU0VfQ0FNUH0sIHRydWUpO1xuICAgICAgfSxcbiAgICAgIHN0YXJ0OiBmYWxzZSxcbiAgICAgIHRpbWVab25lOiAnRXVyb3BlL0Ftc3RlcmRhbSdcbiAgICB9KTtcblxuICAgIGpvYi5zdGFydCgpO1xuXG4gIH1cbn1cblxuY29uc3QgaGFuZGxlRHJ1bmtGcmlkYXkgPSAoKSA9PiB7XG4gIGNvbnN0IGpvYiA9IG5ldyBDcm9uSm9iKHtcbiAgICBjcm9uVGltZTogJyogKiAqICogKiA1JyxcbiAgICBvblRpY2s6IGZ1bmN0aW9uKCkge1xuICAgICAgZHJ1bmtGcmlkYXkgPSB0cnVlO1xuICAgIH0sXG4gICAgc3RhcnQ6IGZhbHNlLFxuICAgIHRpbWVab25lOiAnRXVyb3BlL0Ftc3RlcmRhbSdcbiAgfSk7XG5cbiAgam9iLnN0YXJ0KCk7XG5cbn1cblxuaGFuZGxlQ3JvbkpvYnMoKTtcbiJdfQ==